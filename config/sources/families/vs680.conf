#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#
declare -g ARCH="arm64"
SERIALCON='ttyS0'
LINUXFAMILY=vs680

# Skip all wifi drivers
#declare -g KERNEL_DRIVERS_SKIP+=(driver_generic_bring_back_ipx driver_mt7921u_add_pids driver_rtl8152_rtl8153 driver_rtl8189ES
#	driver_rtl8189FS driver_rtl8192EU driver_rtl8811_rtl8812_rtl8814_rtl8821 driver_xradio_xr819 driver_rtl8811CU_rtl8821C
#	driver_rtl8188EU_rtl8188ETV driver_rtl88x2bu driver_rtw88 driver_rtl88x2cs driver_rtl8822cs_bt driver_rtl8723DS driver_rtl8723DU
#	driver_rtl8822BS driver_uwe5622 driver_rtl8723cs driver_rtl8852bs)

declare -g KERNEL_DRIVERS_SKIP+=(driver_rtl8822BS driver_uwe5622 driver_rtl8723cs driver_rtl8852bs)
KERNELSOURCE='https://github.com/BPI-SINOVOIP/pi-linux.git'
declare -g KERNEL_MAJOR_MINOR="5.4" # Major and minor versions of this kernel
#KERNELBRANCH='branch:pi-5.4-vs680'
KERNELBRANCH='branch:pi-5.4-vs680-hdmi'
KERNELDIR='linux-vs680'
KERNELPATCHDIR='legacy'
ATF_COMPILE="no"

BOOTSOURCE='https://github.com/BPI-SINOVOIP/pi-u-boot.git'
BOOTBRANCH='branch:v2019.10-vs680'
#BOOTCONFIG="vs680_spi_boot_defconfig"
BOOTDIR='u-boot-vs680'
BOOTSCRIPT='boot-vs680.cmd:boot.cmd'
BOOTENV_FILE='vs680.txt'
UBOOT_TARGET_MAP=';;u-boot.bin'

family_tweaks() {
	echo "BPI: do family_tweaks"
	chroot_sdcard ldconfig
	#chroot_sdcard apt-get install chromium
	if [[ -f "$SDCARD/etc/pulse/default.pa" ]]; then
		echo "BPI: do family_tweaks:/etc/pulse/default.pa"
		grep module-udev-detect "$SDCARD/etc/pulse/default.pa"
		cp -a "$SDCARD/etc/pulse/default.pa" "$SDCARD/etc/pulse/default.pa.org"
		sed "s/load-module module-udev-detect tsched=0/load-module module-udev-detect tsched=1 tsched_buffer_size=1024/g" -i  "$SDCARD/etc/pulse/default.pa";
		grep module-udev-detect "$SDCARD/etc/pulse/default.pa"

	else
		display_alert "Can't find pulseaudio config" "${BOARD} - family_tweaks" "warn"
	fi
	true
}

# @TODO: rpardini: this is leaking into the host system (/usr/local), let's not
compile_vs680_bootgen() {
	# Source code checkout
	echo "compile_vs680_bootgen"
}

uboot_custom_postprocess() {
	echo "uboot_custom_postprocess"
}

write_uboot_platform() {
	echo "write_uboot_platform"
	echo dd if=$SRC/packages/blobs/vs680/bpi-m6-tzk-4MB.bin of=$2 bs=512 seek=1 conv=notrunc
	dd if=$SRC/packages/blobs/vs680/bpi-m6-tzk-4MB.bin of=$2 bs=512 seek=1 conv=notrunc
	echo "dd if=$1/u-boot.bin of=$2 bs=1k seek=2048 status=noxfer > /dev/null 2>&1"
	dd if=$1/u-boot.bin of=$2 bs=1k seek=2048 status=noxfer > /dev/null 2>&1
}

family_tweaks_bsp() {
	echo "BPI: family_tweaks_bsp --- START ---"
	for IN in `ls $SRC/packages/bsp/vs680/*.tgz` ; do
	  #IN=$SRC/packages/bsp/vs680/vs680-amp.tgz
	  MNTDIR=$destination

	  echo "tar xf $IN --keep-directory-symlink -C $MNTDIR"
	  tar xf $IN --keep-directory-symlink -C $MNTDIR
	done
	ldconfig
	echo "BPI: family_tweaks_bsp ---  END  ---"
}
