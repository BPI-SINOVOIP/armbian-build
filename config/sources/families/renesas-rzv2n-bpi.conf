#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#
source "${BASH_SOURCE%/*}/include/renesas_common_bpi.inc"

#ASOUND_STATE="${ASOUND_STATE:-"asound.state.renesas-rzv2n-bpi-legacy"}"

#[[ -z $CPUMIN ]] && CPUMIN=480000
#[[ -z $CPUMAX ]] && CPUMAX=1512000
GOVERNOR=ondemand

# Determine kernel
case $BRANCH in
	legacy)	
		declare -g KERNEL_MAJOR_MINOR="5.10"
		declare -g KERNELSOURCE="https://github.com/Dangku/renesas-linux.git"
		declare -g KERNELBRANCH="branch:rzv2hn-5.10"
		declare -g KERNELPATCHDIR="archive/rzv2hn-5.10"
		declare -g KERNELDIR="linux-bpi-rzv2hn"
		declare -g KERNEL_IMAGE_TYPE="Image"
		declare -g KERNEL_INSTALL_TYPE="install" # install uncompressed kernel Image
		declare -g KERNEL_COMPILER="aarch64-none-linux-gnu-"
		declare -g KERNEL_USE_GCC="> 10.0"
		declare -g EXTRAWIFI=no
		;;
esac

ATFSOURCE="https://github.com/Dangku/renesas-atf"
ATFBRANCH="branch:rzv2hn-v2.7"
ATFDIR="arm-trusted-firmware-renesas"
ATF_PLAT="v2n"
ATF_TARGET_MAP="PLAT=v2n all BOARD=evk_1 ENABLE_STACK_PROTECTOR=default bl2 bl31;;build/v2n/release/bl2.bin build/v2n/release/bl31.bin"
ATF_COMPILER="aarch64-none-linux-gnu-"
ATF_USE_GCC="> 10.0"

BOOTSOURCE="https://github.com/Dangku/renesas-u-boot.git"
BOOTBRANCH="branch:rzv2hn-v2021.10"
BOOTPATCHDIR="legacy/u-boot-rzv2hn-v2021.10"
BOOTDIR="u-boot-bpi-rzv2hn"
FORCE_BOOTSCRIPT_UPDATE="yes"
FORCE_UBOOT_UPDATE="yes"
UBOOT_TARGET_MAP=";;u-boot.bin rz_pack/bl2_bp_sd.bin rz_pack/fip.bin"
UBOOT_USE_GCC="> 10.0"
UBOOT_COMPILER="aarch64-none-linux-gnu-"

SKIP_EXTERNAL_TOOLCHAINS="no"

VENDOR="Bananapi-Armbian"
VENDORURL="https://www.banana-pi.org/"
VENDORSUPPORT="https://forum.banana-pi.org/"
VENDORPRIVACY="https://www.banana-pi.org/"
VENDORBUGS="https://forum.banana-pi.org/"
VENDORDOCS="https://wiki.banana-pi.org/"
VENDORLOGO="bpi-logo"
ROOTPWD="1234"
MAINTAINER="Dangku"                             # deb signature
MAINTAINERMAIL="dangku@bananapi.com"

# additional packages install
PACKAGE_LIST_FAMILY=""

# additional packages uninstall
PACKAGE_LIST_FAMILY_REMOVE="btrfs-progs"
if [[ "${RELEASE}" != "bullseye" && "${RELEASE}" != "bookworm" ]]; then
	PACKAGE_LIST_FAMILY_REMOVE+=" update-manager"
fi

function uboot_custom_postprocess()
{
	display_alert "$BOARD" "uboot custom postprocess ${PWD}" "info"

	local pack_tool="$SRC"/packages/blobs/bpi-renesas/tools
	local atfdir="$SRC/cache/sources/$ATFDIR/${ATFBRANCH##*:}"
	local pack_out=rz_pack
	run_host_command_logged mkdir -p ${pack_out}

	local BL2=${atfdir}/build/v2n/release/bl2.bin
	local BL31=${atfdir}/build/v2n/release/bl31.bin

	# create bl2_bp.bin for spi, emmc and sd
        # spi
	${pack_tool}/bptool $BL2 /tmp/bp.bin 0x08103000 spi
	cat /tmp/bp.bin $BL2 > ${pack_out}/bl2_bp_spi.bin

	# emmc
        ${pack_tool}/bptool $BL2 /tmp/bp.bin 0x08103000 mmc
        cat /tmp/bp.bin $BL2 > ${pack_out}/bl2_bp_emmc.bin

        # sd
        ${pack_tool}/bptool $BL2 /tmp/bp.bin 0x08103000 esd
        cat /tmp/bp.bin $BL2 > ${pack_out}/bl2_bp_sd.bin

        # create fip.bin
        ${pack_tool}/fiptool create --align 16 --soc-fw $BL31 --nt-fw u-boot.bin ${pack_out}/fip.bin

        # convert to srec
        objcopy -I binary -O srec --adjust-vma=0x08101E00 --srec-forceS3 ${pack_out}/bl2_bp_spi.bin ${pack_out}/bl2_bp_spi.srec
        objcopy -I binary -O srec --adjust-vma=0x08101E00 --srec-forceS3 ${pack_out}/bl2_bp_emmc.bin ${pack_out}/bl2_bp_emmc.srec
        objcopy -I binary -O srec --adjust-vma=0x08101E00 --srec-forceS3 ${pack_out}/bl2_bp_sd.bin ${pack_out}/bl2_bp_sd.srec
        objcopy -I binary -O srec --adjust-vma=0x44000000 --srec-forceS3 ${pack_out}/fip.bin ${pack_out}/fip.srec
}

function custom_apt_repo__renesas_rzv2n_bpi_apt_list()
{
	:
}

function post_family_tweaks__renesas_rzv2n_bpi_boot_files()
{
	display_alert "$BOARD" "Installing boot files" "info"

	local ubootdir="$SRC/cache/sources/u-boot-worktree/$BOOTDIR/${BOOTBRANCH##*:}"

	# replace bpi bootlogo
	[[ -f "${SDCARD}"/boot/boot.bmp ]] && rm "${SDCARD}"/boot/boot.bmp

	# bootloader
	run_host_command_logged cp -pv ${ubootdir}/rz_pack/* "${SDCARD}"/boot/

	if [[ "$BOARD" == "bpi-ai2n" ]]; then
		# rzv2n
		cp "${SRC}"/packages/blobs/bpi-renesas/bsp/rzv2n/Codec_Bin.bin "${SDCARD}"/boot/Codec_Bin.bin
		cp "${SRC}"/packages/blobs/bpi-renesas/bsp/rzv2n/Flash_Writer_SCIF_RZV2N_DEV_LPDDR4X.mot "${SDCARD}"/boot/Flash_Writer_SCIF_RZV2N_DEV_LPDDR4X.mot
	fi
}

function post_family_tweaks__renesas_rzv2n_bpi_rootfs_files()
{
	display_alert "$BOARD" "Installing rootfs files" "info"

	# copy common board files
	run_host_command_logged rsync -a "${SRC}"/packages/bsp/bpi-renesas/* "${SDCARD}"
}

function post_family_tweaks__renesas_rzv2n_bpi_systemd()
{
	display_alert "${BOARD}" "Installing systemd service" "info"

	# enable systemd service
	# disable systemd service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily.service ]] && disable_systemd_service_sdcard apt-daily.service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily.timer ]] && disable_systemd_service_sdcard apt-daily.timer
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily-upgrade.service ]] && disable_systemd_service_sdcard apt-daily-upgrade.service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily-upgrade.timer ]] && disable_systemd_service_sdcard apt-daily-upgrade.timer
}

function post_family_tweaks__renesas_rzv2n_bpi_docker()
{
	display_alert "${BOARD}" "Installing docker setup script" "info"

	# docker install script
	install -m 755 "${SRC}"/packages/blobs/bpi-renesas/docker/${RELEASE}/docker_install.sh "${SDCARD}"/usr/local/bin
}

function post_family_config__renesas_rzv2n_bpi_imagedebs()
{
	display_alert "${BOARD}" "Adding packages to image" "info"

	# install packages to image
        #add_packages_to_image xxx
        #remove_packages xxx
}

function post_install_kernel_debs__renesas_rzv2n_bpi_dtbpath()
{
	display_alert "${BOARD}" "Changing dtb path for armbian-config" "info"
}

function pre_customize_image__renesas_rzv2n_bpi()
{
	display_alert "${BOARD}" "Customizing board image" "info"
}
